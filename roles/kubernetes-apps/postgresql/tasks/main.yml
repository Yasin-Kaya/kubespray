---
# ========================
# POSTGRESQL KALDIRMA (postgresql_enabled: false)
# ========================
- name: PostgreSQL | Remove ArgoCD Application
  command: "{{ bin_dir }}/kubectl delete application postgresql -n {{ postgresql_argocd_namespace }} --ignore-not-found"
  become: true
  when:
    - not postgresql_enabled
    - inventory_hostname == groups['kube_control_plane'][0]
  ignore_errors: true

- name: PostgreSQL | Remove ArgoCD AppProject
  command: "{{ bin_dir }}/kubectl delete appproject {{ postgresql_argocd_project }} -n {{ postgresql_argocd_namespace }} --ignore-not-found"
  become: true
  when:
    - not postgresql_enabled
    - inventory_hostname == groups['kube_control_plane'][0]
  ignore_errors: true

- name: PostgreSQL | Remove namespace
  command: "{{ bin_dir }}/kubectl delete namespace {{ postgresql_namespace }} --ignore-not-found"
  become: true
  when:
    - not postgresql_enabled
    - inventory_hostname == groups['kube_control_plane'][0]
  ignore_errors: true

# ========================
# POSTGRESQL KURULUM - ArgoCD Application
# ========================
- name: PostgreSQL | Create namespace
  become: true
  template:
    src: "postgresql-namespace.yml.j2"
    dest: "{{ kube_config_dir }}/postgresql-namespace.yml"
    mode: "0644"
  when:
    - postgresql_enabled
    - inventory_hostname == groups['kube_control_plane'][0]

- name: PostgreSQL | Apply namespace
  become: true
  kube:
    name: PostgreSQL
    kubectl: "{{ bin_dir }}/kubectl"
    filename: "{{ kube_config_dir }}/postgresql-namespace.yml"
    state: latest
  when:
    - postgresql_enabled
    - inventory_hostname == groups['kube_control_plane'][0]

- name: PostgreSQL | Create ArgoCD AppProject
  become: true
  template:
    src: "postgresql-argocd-project.yml.j2"
    dest: "{{ kube_config_dir }}/postgresql-argocd-project.yml"
    mode: "0644"
  when:
    - postgresql_enabled
    - inventory_hostname == groups['kube_control_plane'][0]

- name: PostgreSQL | Apply ArgoCD AppProject
  become: true
  kube:
    name: PostgreSQL AppProject
    kubectl: "{{ bin_dir }}/kubectl"
    filename: "{{ kube_config_dir }}/postgresql-argocd-project.yml"
    state: latest
  when:
    - postgresql_enabled
    - inventory_hostname == groups['kube_control_plane'][0]

- name: PostgreSQL | Create ArgoCD Application
  become: true
  template:
    src: "postgresql-argocd-app.yml.j2"
    dest: "{{ kube_config_dir }}/postgresql-argocd-app.yml"
    mode: "0644"
  when:
    - postgresql_enabled
    - inventory_hostname == groups['kube_control_plane'][0]

- name: PostgreSQL | Apply ArgoCD Application
  become: true
  kube:
    name: PostgreSQL Application
    kubectl: "{{ bin_dir }}/kubectl"
    filename: "{{ kube_config_dir }}/postgresql-argocd-app.yml"
    state: latest
  when:
    - postgresql_enabled
    - inventory_hostname == groups['kube_control_plane'][0]

- name: PostgreSQL | Wait for ArgoCD to sync PostgreSQL
  command: "{{ bin_dir }}/kubectl wait --for=jsonpath='{.status.health.status}'=Healthy application postgresql -n {{ postgresql_argocd_namespace }} --timeout=5m"
  become: true
  when:
    - postgresql_enabled
    - postgresql_argocd_sync_policy == 'automated'
    - inventory_hostname == groups['kube_control_plane'][0]
  ignore_errors: true
