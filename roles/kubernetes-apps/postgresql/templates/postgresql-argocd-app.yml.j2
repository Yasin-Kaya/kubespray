---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: postgresql
  namespace: {{ postgresql_argocd_namespace }}
spec:
  project: {{ postgresql_argocd_project }}
  source:
    repoURL: "{{ postgresql_helm_repo_url }}"
    chart: postgresql
    targetRevision: "{{ postgresql_version }}"
    helm:
      values: |
        auth:
          username: "{{ postgresql_username }}"
          password: "{{ postgresql_password }}"
          database: "{{ postgresql_database }}"
        primary:
          persistence:
            enabled: {{ postgresql_pvc_enabled | lower }}
            size: "{{ postgresql_pvc_size }}"
{% if postgresql_pvc_storage_class %}
            storageClass: "{{ postgresql_pvc_storage_class }}"
{% endif %}
          service:
            type: "{{ postgresql_service_type }}"
{% if postgresql_service_type == 'NodePort' %}
            nodePorts:
              postgresql: {{ postgresql_nodeport }}
{% endif %}
  destination:
    server: https://kubernetes.default.svc
    namespace: {{ postgresql_namespace }}
{% if postgresql_argocd_sync_policy == 'automated' %}
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
{% else %}
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
{% endif %}
