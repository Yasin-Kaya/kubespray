---
# ========================
# PGADMIN KURULUM - ArgoCD Application
# ========================
- name: pgAdmin | Create namespace
  become: true
  template:
    src: "pgadmin-namespace.yml.j2"
    dest: "{{ kube_config_dir }}/pgadmin-namespace.yml"
    mode: "0644"
  when:
    - pgadmin_enabled
    - inventory_hostname == groups['kube_control_plane'][0]

- name: pgAdmin | Apply namespace
  become: true
  kube:
    name: pgAdmin
    kubectl: "{{ bin_dir }}/kubectl"
    filename: "{{ kube_config_dir }}/pgadmin-namespace.yml"
    state: latest
  when:
    - pgadmin_enabled
    - inventory_hostname == groups['kube_control_plane'][0]

- name: pgAdmin | Create ArgoCD AppProject
  become: true
  template:
    src: "pgadmin-argocd-project.yml.j2"
    dest: "{{ kube_config_dir }}/pgadmin-argocd-project.yml"
    mode: "0644"
  when:
    - pgadmin_enabled
    - inventory_hostname == groups['kube_control_plane'][0]

- name: pgAdmin | Apply ArgoCD AppProject
  become: true
  kube:
    name: pgAdmin AppProject
    kubectl: "{{ bin_dir }}/kubectl"
    filename: "{{ kube_config_dir }}/pgadmin-argocd-project.yml"
    state: latest
  when:
    - pgadmin_enabled
    - inventory_hostname == groups['kube_control_plane'][0]

- name: pgAdmin | Create ArgoCD Application
  become: true
  template:
    src: "pgadmin-argocd-app.yml.j2"
    dest: "{{ kube_config_dir }}/pgadmin-argocd-app.yml"
    mode: "0644"
  when:
    - pgadmin_enabled
    - inventory_hostname == groups['kube_control_plane'][0]

- name: pgAdmin | Apply ArgoCD Application
  become: true
  kube:
    name: pgAdmin Application
    kubectl: "{{ bin_dir }}/kubectl"
    filename: "{{ kube_config_dir }}/pgadmin-argocd-app.yml"
    state: latest
  when:
    - pgadmin_enabled
    - inventory_hostname == groups['kube_control_plane'][0]

- name: pgAdmin | Wait for ArgoCD to sync pgAdmin
  command: "{{ bin_dir }}/kubectl wait --for=jsonpath='{.status.health.status}'=Healthy application pgadmin -n {{ pgadmin_argocd_namespace }} --timeout=5m"
  become: true
  when:
    - pgadmin_enabled
    - pgadmin_argocd_sync_policy == 'automated'
    - inventory_hostname == groups['kube_control_plane'][0]
  ignore_errors: true

# ========================
# PGADMIN KALDIRMA (pgadmin_enabled: false)
# ========================
- name: pgAdmin | Remove ArgoCD Application
  command: "{{ bin_dir }}/kubectl delete application pgadmin -n {{ pgadmin_argocd_namespace }} --ignore-not-found"
  become: true
  when:
    - not pgadmin_enabled
    - inventory_hostname == groups['kube_control_plane'][0]
  ignore_errors: true

- name: pgAdmin | Remove ArgoCD AppProject
  command: "{{ bin_dir }}/kubectl delete appproject {{ pgadmin_argocd_project }} -n {{ pgadmin_argocd_namespace }} --ignore-not-found"
  become: true
  when:
    - not pgadmin_enabled
    - inventory_hostname == groups['kube_control_plane'][0]
  ignore_errors: true

- name: pgAdmin | Remove namespace
  command: "{{ bin_dir }}/kubectl delete namespace {{ pgadmin_namespace }} --ignore-not-found"
  become: true
  when:
    - not pgadmin_enabled
    - inventory_hostname == groups['kube_control_plane'][0]
  ignore_errors: true


